
<html>

    <head>

        <title>Grey Pantera</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, maximum-scale=1.0" />

        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
        <link rel="manifest" href="site.webmanifest">
        <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <link href='stylesheets/pantera.css' rel='stylesheet' />
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script src='https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css' rel='stylesheet' />
    
    </head>

    <body id="body">
        <div id="info">
            <h1 id="addr"></h1>
            <div id="sign"></div>
        </div>

        <div id="map"></div>

        <script type="text/javascript">

            function getQueryString (name) {
                function parseParams() {
                    var params = {},
                        e,
                        a = /\+/g,
                        r = /([^&=]+)=?([^&]*)/g,
                        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
                        q = window.location.search.substring(1);

                    while (e = r.exec(q))
                        params[d(e[1])] = d(e[2]);

                    return params;
                }

                if (!this.queryStringParams)
                    this.queryStringParams = parseParams();

                return this.queryStringParams[name];
            }

            function getStreetSweeping (json) {
               $.getJSON('https://api.xtreet.com/roads2/getnearesttolatlng/?longitude=' + json.longitude + '&latitude=' + json.latitude, function (response) {
                    console.log(response);

                    if ($.isArray(response.rows)) {
                        var row = response.rows[0];
                        
                        if (row.properties) {
                            if (row.properties.cleaning_info) {
                                $('#sign').append('<p class="cleaning_info">' + row.properties.cleaning_info + '</p>');
                            }

                            if (row.properties.cleaning_time_start) {
                                var date = moment.unix(row.properties.cleaning_time_start).utc();

                                if (date.isValid()) {
                                    // replace with formatted
                                    $('#sign .cleaning_info').remove();
                                    $('#sign').append('<p class="cleaning_info">Next street sweeping: <strong>' + date.format('dddd, MMMM Do, h:mma') + '</strong></p>');
                                }
                            }

                            if (row.properties.sign_info) {
                                $('#sign').append('<p>' + row.properties.sign_info + '</p>');
                            }
                        }
                    }

                    $('body').addClass('with-street-info');
               });
            }

            function getAddress (json) {
                $.getJSON('https://api.mapbox.com/geocoding/v5/mapbox.places/' + json.longitude + ',' + json.latitude + '.json?access_token=' + mapboxgl.accessToken, function (response) {
                    console.log(response);
                    
                    if ($.isArray(response.features)) {
                        $.each(response.features, function (i, obj) {
                            if (obj.place_type[0] == 'address') {
                                console.log(obj);

                                var str = [];

                                if (obj.address) str.push(obj.address);
                                if (obj.text) str.push(obj.text);
                                
                                if (str.length > 0) {
                                    $('#addr').html(str.join(' '));    
                                } else {
                                    $('#addr').remove();
                                }
                                
                                return false;
                            }
                        });
                    }

                    $('body').addClass('with-geocoded');
                });
            }

            function setDate (timestamp) {
                var date = moment(timestamp);
                if (!date.isValid()) return; 

                var div = $('<div id="date" />');
                div.html('Parked at <strong>' + date.format('dddd, MMMM Do, h:mma') + '</strong>');

                $('body').append(div);
            }

            function init () {
                // init map
                $.getJSON('json/?vehicleId=' + getQueryString('vehicleId') + '&token=' + getQueryString('token'), function (json) {
                    console.log(json);

                    if (json.error) {
                        alert('There was a problem reading the Pulse: ' + json.error);
                        return;
                    }

                    if (json.timestamp) setDate(json.timestamp);

                    var coords = [json.longitude, json.latitude];

                    var map = new mapboxgl.Map({
                        container: 'map',
                        center: coords,
                        zoom: 17,
                        style: 'mapbox://styles/mapbox/light-v10?optimize=true'
                    });

                    var el = document.createElement('div');
                    el.innerHTML = '<div class="inner"></div>';
                    el.className = 'marker';

                    new mapboxgl.Marker(el).setLngLat(coords).addTo(map);

                    getAddress(json);
                    getStreetSweeping(json);
                });
                
                // toggle legend
                var debounce = null;

                $('body').on('touchstart mousedown', function () {
                    clearTimeout(debounce);
                    $(this).addClass('interacting');
                });
                
                

                $('body').on('touchend mouseup', function () {
                    clearTimeout(debounce);
                    
                    debounce = setTimeout(function () {
                        $('body').removeClass('interacting');
                    }, 500);
                });

                // stay fresh
                $(window).on('focus', function () {
                    if ($('body').hasClass('hidden')) {
                        window.location.reload();
                    }
                });

                $(window).on('blur', function () {
                    $('body').addClass('hidden');
                });
            }

            mapboxgl.accessToken = getQueryString('mapbox_token');
            init();

        </script>
    </body>

</html>
